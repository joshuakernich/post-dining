<!DOCTYPE html>
<html>
<head>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Restraint</title>
   <script type="text/javascript" src='./js/jq.js'></script>
   <script type="text/javascript" src='./js/screen-pin.js'></script>
   <script type="text/javascript" src='./js/screen-shop.js'></script>
   <script type="text/javascript" src='./js/screen-herald.js'></script>
   <script type="text/javascript" src='./js/screen-alloc.js'></script>
   <script type="text/javascript" src='./js/screen-lecture.js'></script>
   <script type="text/javascript">
    
    // changeable data
    var DATA = {};

   </script>
   <script type="text/javascript" src='./data/data-burger-bar.js'></script>
   <!--script type="text/javascript" src='./data/data-show.js'></script-->
   <link rel="stylesheet" href="./index.css">
   <link rel="stylesheet" href="./shop.css">
  
  <script type="text/javascript">


    $(function(){

      var types = {
        'screen-herald':ScreenHerald,
        'screen-lecture':ScreenLecture,
        'screen-alloc':ScreenAlloc,
        'screen-shop':ScreenShop,
        'screen-pin':ScreenPin,
      }

      var utils = {
        utter:utter,
        toNextScreen:toNextScreen,
        doAnimatedType:doAnimatedType,
        doAnimatedStat:doAnimatedStat,
      }

      var screens = [];

      var synth = window.speechSynthesis;
      var utters = [];

      //load up the data
      for(var s in DATA.sequence){
        var def = DATA.sequence[s];
        var $s = $('.screen-templates .'+def.type).clone().appendTo('.device');

        var fn = types[def.type];
        screens[s] = new fn($s,def,utils);

        $s.find('.action-to-next-screen').click(onNextScreen);
      }

      function onNextScreen(e){
        toNextScreen(e.target);
      }

      function toNextScreen(child){
        var idx = $('.device .screen').index($(child).closest('.screen'));
        if(idx+1 >= $('.device .screen').length){
          window.location = window.location; // HARD RESET
        } else {
          toScreen(idx+1);
        }
      }

      function toScreen(idx){

        while(utters.length) clearInterval(utters.pop());
        synth.cancel();

        $('.device .screen').hide().eq(idx).show();
        if(screens[idx].activate) screens[idx].activate();
      }

      function utter(text,delay){
        if(DATA.isMuted) return;
        utters.push( setTimeout(function(){
            var utter = new SpeechSynthesisUtterance(text);
            utter.voice = synth.getVoices()[0];
            synth.speak(utter);
          },delay));
      }

      function doAnimatedType( $d, delay, bUtter ){
        var text = $d.text();
        var chars = '<span>'+text.split('').join('</span><span>') + '</span>';
        $d.html(chars);

        $d.find('span').each(function(i){

          $(this).css({opacity:0,background:'orange'}).delay(delay+i*50).animate({opacity:1},40,function(){
            $(this).css({background:'transparent'});
          });
        });

        if(bUtter){
          utter(text,delay);
        }

        return text.length*50;
      }

      function doAnimatedStat( $d, delay ){
        var text = $d.text();
        var int = parseInt(text);
        $d.css({opacity:0}).delay(delay).animate({opacity:1},10);

        $d.text('0');
        
        $({int:0}).delay(delay).animate({int:int},{duration:text.length*100,step:function(val){
          
          $d.text(Number(Math.floor(val)).toLocaleString());
          $('.sound-blip')[0].play();
        }})

        return text.length*100;
      }


      /*for(var l in layers){
        var $s = $('<div class="screen screen-selector screen-breadcrumbed">').insertBefore('.screen-checkout');
        $('<h1>'+layers[l].title+'</h1>').appendTo($s);

        for(var i in layers[l].list){
          var $ing = $('<div class="ingredient">\
            <div class="ingredient-img" style="background-image:url('+layers[l].list[i].img+')"></div>\
            <h2><span class="name">'+layers[l].list[i].name+'</span> <span class="wd">'+layers[l].list[i].wd+'</span></h2>\
            <p>'+layers[l].list[i].d+'</p>\
            <button></button>\
          </div>').appendTo($s);

          $ing.data('bean',layers[l].list[i]);
          if(layers[l].isABurger) $ing.addClass('is-a-burger');
        }

        $('<li>'+layers[l].short+'<div class="ing"></div></li>').insertBefore('.breadcrumbs li:last-of-type');
        $('<h2><span class="name">-</span> <span class="wd">0</span></h2>').insertBefore('.summary-box hr');
        $('<div class="ing-summary"></div>').appendTo('.summary');
        $('.wd-of').text(alloc);

        //add an extra layer for the burger top
        if(layers[l].isABurger) $('<div class="ing-summary"></div>').appendTo('.summary');
      }

      $('.intro-monologue').html(intro);

      
     
      var spend = [0,0,0];
      var utters = [];

      toScreen(0);

      $('.action-to-next-screen').click(function(){
        toNextScreen(this);
      })

      $('.action-to-start').click(function(){
        //toScreen(0);
        window.location = window.location;
      })

      

      


      function utter(text,delay){
        if(isMuted) return;
        utters.push( setTimeout(function(){
            var utter = new SpeechSynthesisUtterance(text);
            utter.voice = synth.getVoices()[0];
            synth.speak(utter);
          },delay));
      }

      


      $('.screen-lecture button, .screen-alloc button, .screen-checkout button').click(function(){
        $('.sound-select')[0].play();
      })


      function toNextScreen(child){
        var idx = $('.screen').index($(child).closest('.screen'));
        toScreen(idx+1);
      }

      function toScreen(idx){

        while(utters.length) clearInterval(utters.pop());
        synth.cancel();

        var $s = $('.screen').hide().eq(idx).show();

        if($s.is('.screen-selector')){
          
          $s.find('h1').css({position:'relative',top:-200}).animate({top:0});


          utter($s.find('h1').text(),500);

          $s.find('.ingredient').each(function(i){

            $(this).addClass('static').width(0).height(0).delay((i+1)*300).animate({width:220,height:10},300).delay(100).animate({height:200},300,function(){
              $(this).removeClass('static').css({width:'',height:''});
            });


          })
        } else if($s.is('.screen-alloc')){
          
          if(skipAllocation){
            toNextScreen($s);
            return;
          }

          var d = 500;

          d += doAnimatedType( $s.find('.stockpile .wd-stat'), d ) + 500;
          d += doAnimatedStat( $s.find('.stockpile .wd'), d ) + 1000;
          d += doAnimatedType( $s.find('h2'), d, true ) + 1000;

          $s.find('.wd-chart li').each(function(){
            d += doAnimatedType( $(this).find('.wd-stat'), d ) + 800;
            d += doAnimatedStat( $(this).find('.wd'), d ) + 500;
          })

          utter("Your allocation for today is "+alloc+" water dollars.",d);

          $s.find('button').css({opacity:0}).delay(d).animate({opacity:1},100);
   
        } else if($s.is('.screen-checkout')){

          $s.find('.ing-summary').each(function(n){
            $(this).css({top:-500}).delay(400*(n+1)).animate({top:-50*n});
          })


          var total = 0;
           $('.summary-box .wd:not(.wd-total)').each(function(){
            total += parseFloat($(this).text());
           })

           $('.summary-box .wd-total').text(total);

            $('.summary-box h2').each(function(n){
              doAnimatedType($(this).find('.name'),1000+n*200);
              doAnimatedStat($(this).find('.wd'),1200+n*200);
            })

            

           if(total>alloc){
              $('.wd-total').addClass('overspend');
              $('.alloc-error').show();
              $s.find('button').hide();
              doAnimatedType($('.alloc-error'),2500,true);
            } else {
              $('.wd-total').removeClass('overspend');
              $('.alloc-error').hide();
              $s.find('button').show().css({opacity:0}).delay(2500).animate({opacity:1},100);
              utter("A fine selection for a socially responsible member of society.",2000)
            }

            

        } else if($s.is('.screen-lecture')){

          var delay = 500;
          $s.find('p').each(function(){
            delay += doAnimatedType($(this),delay,true) + 1000;
          })

          
        } else if($s.is('.screen-outro')){
          //utter("Thank you for trusting GWAT. Your Global Water Allocation Trust... Your personal Canap√© Code is... A... 2... B.",500);
          utter(outro,500);
        }

        if($s.is('.screen-breadcrumbed')){
          $('.wd-alloc').removeClass('hidden');
          $('.breadcrumbs').removeClass('hidden');
          
          var idx = $('.screen-breadcrumbed').index($s);
          $('.breadcrumbs li').removeClass('active').eq(idx).addClass('active');

        } else {
          $('.wd-alloc').addClass('hidden');
          $('.breadcrumbs').addClass('hidden');
        }
      }

      $('.ingredient').click(function(){
        $(this).closest('.screen').find('.ingredient').removeClass('active');
        $(this).addClass('active');
      })

     

      */
    })
  </script>
  <div class="screen-templates">
    <div class="screen screen-pin">
      <div class="layer" style="opacity:0.2;background-image: url(./globe-orange.gif)"></div>
      <div class="layer" style="text-align: center;">
        <br>
        <div class="box">
          <img width="90"style="vertical-align:middle;display: inline-block;" src='./water-dollar-symbol.png'>
          <div style="vertical-align:middle;display:inline-block;text-align:center;">
            <p style="font-size:180px;line-height:100px;margin:0px;">GWAT</p>
            <p style="margin:10px;font-size: 22px;">Global Water Allocation Trust</p>
          </div>
          <br>
        </div><br>
        <div class="box">
        <h2>Enter Personal ID CODE</h2>
          <div class="pins">
            <div class="pin focus"></div>
            <div class="pin"></div>
            <div class="pin"></div>
            <div class="pin"></div>
          </div>
           </div>
        <div class="keypad"></div>
      </div>
    </div>
    <div class="screen screen-herald">
      <div class="layer" style="opacity:0.2;background-image: url(./globe-orange.gif)"></div>
      <div class="layer" style="text-align: center;">
        <br><br>
        <div class="box">
          <br><br>
          <h1>Hello</h1>
          <br><br>
          <button class="action-to-next-screen">BEGIN</button>
        </div>
      </div>
    </div>
    <div class="screen screen-lecture" style='padding:100px;'>
       <div class="layer" style="opacity:0.6;background-image: url(./ripples.gif)"></div>
       <div class="layer">
        <div class="box" style="text-align: left;padding:20px 50px;margin-top: 50px;">
          <div class="intro-monologue">
            <!-- lecture goes here -->
          </div>
        <button class="action-to-next-screen">Let's Crack On</button></div>
      </div>
    </div>
    <div class="screen screen-alloc">
       <div class="layer" style="opacity:0.6;background-image: url(./ripples.gif)"></div>
       <div class="layer">
        <br>
        <div class="box">

          <p class="stockpile"><span class='wd-stat pos'>WORLD WATER stockpile</span><span class='wd'>89582618271</span></p>
          <h2 style="font-size: 35px;">Calculating personal water allocation.</h2>

          <ul class="wd-chart">
            <li><span class='wd-stat pos'>Universal daily allocation</span><span class='wd'>212</span></li>
            <li><span class='wd-stat'>Shower: 6 minutes</span><span class='wd neg'>37</span></li>
            <li><span class='wd-stat'>Faucet: 12 seconds</span><span class='wd neg'>6</span></li>
            <li><span class='wd-stat'>Faucet: 15 seconds</span><span class='wd neg'>8</span></li>
            <li><span class='wd-stat pos'>TOTAL ALLOCATION</span><span class='wd total'>152</span></li>
          </ul>
          <br>
          <button class="action-to-next-screen">REDEEM ALLOCATION</button>
        </div>
      </div>
    </div>
    <div class="screen screen-shop">
      <!-- other shop pages will be inserted here -->
      <div class="shop-page shop-page-checkout">
        <div class="summary">
        <!-- ingredient images here -->
        </div>
        <div class="box summary-box">
          <!-- ingredient list here -->
          <hr>
          <h2><span class='name'>TOTAL</span> <span class="wd wd-total">32</span></h2>
          <br>
          <p class='alloc-error' style="color:red;margin:0px;">You have exceeded your water allocation. Please select an ingredient to change.</p>
          <button class="action-to-next-screen">REDEEM</button>
        </div>
        
      </div>
      <div class="wd-alloc"><span class='wd-spent'>0</span> of <span class="wd-of">152</span></div>
      <ul class="breadcrumbs"><li>Checkout</li></ul>
      <!--div class="screen screen-outro">
        <div class="layer" style="opacity:0.2;background-image: url(./globe-orange.gif)"></div>
        <div class="layer" style="text-align: center;">
          <br>
          <br>
          <br>
          <div class="box">
            <h1>Thankyou for making choices that support a fair water distribution for all.</h1>
            <br><br>
            <button class="action-to-start">FINISH</button>
          </div>
        </div>
      </div-->
    </div>
  </div>
</head>
<body>
  
  <div class="device">
    
    
    

    
    
    <!--div class="screen screen-selector screen-breadcrumbed">

        <h1>Select a <b>Carbohydrate</b></h1>

          <div class="ingredient">
            <div class="ingredient-img" style="background-image:url(./img/wafer.png)"></div>
            <h2><span class='name'>Wafer</span> <span class="wd">12</span></h2>
            <p>A delicate cracker with a crunchy texture.</p>
            <button>Confirm</button>
          </div>
          <div class="ingredient">
            <div class="ingredient-img" style="background-image:url(./img/crispbread.png)"></div>
            <h2><span class='name'>Crispbread</span> <span class="wd">32</span></h2>
            <p>Sun-ripened maize, popped and pressed.</p>
            <button>Confirm</button>
          </div>
          <div class="ingredient">
            <div class="ingredient-img" style="background-image:url(./img/bread.png)"></div>
            <h2><span class='name'>Bread</span> <span class="wd">96</span></h2>
            <p>Wheat dough, ground, rested, and baked.</p>
            <button>Confirm</button>
          </div>

    </div>
    <div class="screen screen-selector screen-breadcrumbed">

        <h1>Select a <b>Protein</b></h1>

          <div class="ingredient">
            <div class="ingredient-img" style="background-image:url(./img/cheese.png)"></div>
            <h2><span class='name'>Cheese</span> <span class="wd">12</span></h2>
            <p>Cow nipple juice and some bacteria.</p>
            <button>Confirm</button>
          </div>
          <div class="ingredient">
            <div class="ingredient-img" style="background-image:url(./img/salmon.png)"></div>
            <h2><span class='name'>Salmon</span> <span class="wd">32</span></h2>
            <p>Farm-grown, caught, and smoked.</p>
            <button>Confirm</button>
          </div>
          <div class="ingredient">
            <div class="ingredient-img" style="background-image:url(./img/lamb.png)"></div>
            <h2><span class='name'>Lamb</span> <span class="wd">96</span></h2>
            <p>Farm raised, slaughtered, and aged.</p>
            <button>Confirm</button>
          </div>
        
    </div>
    <div class="screen screen-selector screen-breadcrumbed">
        
        <h1>Select a <b>Topping</b></h1>

          <div class="ingredient">
            <div class="ingredient-img" style="background-image:url(./img/parsley.png)"></div>
            <h2><span class='name'>Parsley</span> <span class="wd">12</span></h2>
            <p>A little bitter, leafy thingo.</p>
            <button>Confirm</button>
          </div>
          <div class="ingredient">
            <div class="ingredient-img" style="background-image:url(./img/salsa.png)"></div>
            <h2><span class='name'>Salsa</span> <span class="wd">32</span></h2>
            <p>A blob of chunky, red sunshine.</p>
            <button>Confirm</button>
          </div>
          <div class="ingredient">
            <div class="ingredient-img" style="background-image:url(./img/aoili.png)"></div>
            <h2><span class='name'>Aoili</span> <span class="wd">96</span></h2>
            <p>Creamy, eggy white gloop.</p>
            <button>Confirm</button>
          </div>
        
    </div-->
    <!--div class="screen screen-checkout screen-breadcrumbed">
      
    </div-->
     <!--div class="screen screen-outro">
      <div class="layer" style="opacity:0.2;background-image: url(./globe-orange.gif)"></div>
 
      <div class="layer" style="text-align: center;">
        <br>
        <div class="box">
         
          <img width="90"style="vertical-align:middle;display: inline-block;" src='./water-dollar-symbol.png'>
          <div style="vertical-align:middle;display:inline-block;text-align:center;">
            <p style="font-size:180px;line-height:100px;margin:0px;">GWAT</p>
            <p style="margin:10px;font-size: 22px;">Global Water Allocation Trust</p>
          </div>
          <br>
        </div>
        <div class="box">
          Personal CANAPE CODE
          <h1 style="color:var(--col-b);font-size: 150px;">A2B</h1>
          <button class="action-to-start">FINISH</button>
        </div>
        
      </div>
    </div-->
    
    
  </div>
  <audio class="sound-blip">
    <source src="./blip.wav" type="">
  </audio>
  <audio class="sound-select">
    <source src="./select.wav" type="">
  </audio>
</body>
</html>